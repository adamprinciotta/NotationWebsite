<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Combo Overlay – Editable Chips (v14)</title>
  <style>
    :root{
      --chip-text:#000;
      --chip-bg:#f5f5f5;
      --sep:" > ";
      --chip-font:18px; --chip-pad-x:12px; --chip-pad-y:6px; --chip-gap:10px; --chip-radius:10px; --chip-img-h:20px;
    }
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans";background:#1b1e25;color:#e7e7ea}
    *{box-sizing:border-box}

    /* ===== OVERLAY ===== */
    #overlayWrap{position:sticky;top:0;padding:10px 12px;background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0))}
    #overlay{display:flex;flex-wrap:wrap;align-items:center;gap:var(--chip-gap);background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px 12px;min-height:48px}
    .chip{display:inline-flex;align-items:center;gap:6px;font-weight:800;font-size:var(--chip-font);line-height:1;padding:var(--chip-pad-y) var(--chip-pad-x);border-radius:var(--chip-radius);background:var(--chip-bg);color:var(--chip-text);border:1px solid rgba(0,0,0,.25);user-select:none;cursor:pointer;outline:none}
    .chip.selected{box-shadow:0 0 0 2px rgba(58,76,255,.6)}
    .sep{font-weight:900;opacity:.9;user-select:none}
    .img{height:var(--chip-img-h);vertical-align:middle}

    /* ===== UI ===== */
    .panel{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px}
    .card{background:#232836;border:1px solid #2a2f3a;border-radius:10px;padding:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid #2a2f3a;border-radius:8px;padding:8px 10px;cursor:pointer;font-weight:700;background:#2a3040;color:#eef0f5}
    input[type="color"],input[type="number"],select{width:100%;padding:6px 8px;border-radius:8px;border:1px solid #2a2f3a;background:#262b36;color:#eef0f5}

    /* ===== Popover (chip editor) ===== */
    .popover{position:fixed;z-index:10000;background:#151821;border:1px solid #2a2f3a;color:#e7ebf3;border-radius:10px;padding:8px;box-shadow:0 8px 26px rgba(0,0,0,.45);width:280px}
    .popover h5{margin:0 0 6px;font-size:12px;color:#9aa3b2}
    .popover .row{grid-template-columns:1fr auto}
    .popover input[type="text"]{width:100%;padding:6px 8px;border-radius:8px;border:1px solid #2a2f3a;background:#262b36;color:#eef0f5}
    .popover .btn{width:auto}
    .popover .btn.danger{background:#7d2236;border-color:#7d2236}
  </style>
</head>
<body>
  <div id="overlayWrap"><div id="overlay" aria-live="polite"></div></div>

  <div class="panel">
    <div class="card">
      <div class="row"><label>Global chip BG <input type="color" id="chipBgAll" value="#f5f5f5"></label><label>Global chip text <input type="color" id="chipTextAll" value="#000000"></label></div>
      <div class="row"><label>Font (px)<input type="number" id="chipFont" value="18"></label><label>Icon H (px)<input type="number" id="chipImgH" value="20"></label></div>
      <div class="row"><label>Pad X<input type="number" id="chipPadX" value="12"></label><label>Pad Y<input type="number" id="chipPadY" value="6"></label></div>
      <div class="row"><label>Gap<input type="number" id="chipGap" value="10"></label><label>Radius<input type="number" id="chipRadius" value="10"></label></div>
      <div class="row"><label>Separator<input type="text" id="separator" value=">"></label><label>Reset button<select id="resetAction"></select></label></div>
      <div class="row"><button id="exportImg" class="btn">Export PNG</button><button id="copyImg" class="btn">Copy PNG</button></div>
      <div class="row"><button id="copyTxt" class="btn">Copy Text (Numpad)</button><button id="clearBtn" class="btn">Clear</button></div>
      <div class="row"><small>Tips: Click chip to edit · Delete to remove · Double‑click to edit from controller · Up/Space adds <b>j.</b> · E toggles settings in OBS</small></div>
    </div>
    <div class="card">
      <div class="row" style="grid-template-columns:1fr"><button id="addDemo" class="btn">Add demo chips</button></div>
      <div class="row" style="grid-template-columns:1fr"><small id="status">No gamepad. Press any controller button to connect…</small></div>
    </div>
  </div>

  <div id="popover" class="popover" style="display:none"></div>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
  /* ===== Shorthands ===== */
  const $=s=>document.querySelector(s);
  const overlay=$('#overlay');
  const statusEl=$('#status');
  const popover=$('#popover');
  let currentSelectedChip=null; let editCaptureMode=false; // controller-driven edit

  /* ===== Live knobs ===== */
  const knobs={ chipBgAll:$('#chipBgAll'), chipTextAll:$('#chipTextAll'), chipFont:$('#chipFont'), chipImgH:$('#chipImgH'), chipPadX:$('#chipPadX'), chipPadY:$('#chipPadY'), chipGap:$('#chipGap'), chipRadius:$('#chipRadius'), separator:$('#separator') };
  function applyKnobs(){ document.documentElement.style.setProperty('--chip-bg', knobs.chipBgAll.value); document.documentElement.style.setProperty('--chip-text', knobs.chipTextAll.value); document.documentElement.style.setProperty('--chip-font', knobs.chipFont.value+'px'); document.documentElement.style.setProperty('--chip-img-h', knobs.chipImgH.value+'px'); document.documentElement.style.setProperty('--chip-pad-x', knobs.chipPadX.value+'px'); document.documentElement.style.setProperty('--chip-pad-y', knobs.chipPadY.value+'px'); document.documentElement.style.setProperty('--chip-gap', knobs.chipGap.value+'px'); document.documentElement.style.setProperty('--chip-radius', knobs.chipRadius.value+'px'); document.documentElement.style.setProperty('--sep', JSON.stringify(' '+(knobs.separator.value||'>')+' ')); }
  Object.values(knobs).forEach(inp=>inp.addEventListener('input',applyKnobs)); applyKnobs();

  /* ===== Add / remove chips ===== */
  function addSeparator(){ if(overlay.children.length){ const s=document.createElement('span'); s.className='sep'; s.textContent=(knobs.separator.value||'>'); overlay.appendChild(s);} }
  function addChip(content, dirTok='n'){ if(overlay.children.length) addSeparator(); const c=document.createElement('span'); c.className='chip'; c.innerHTML=content; c.dataset.dir=dirTok; c.tabIndex=0; c.addEventListener('click', ev=>{ selectChip(c); openPopover(c); ev.stopPropagation();}); c.addEventListener('dblclick', ev=>{ selectChip(c); openPopover(c,true); startControllerEdit(); ev.stopPropagation();}); overlay.appendChild(c); overlay.scrollLeft=overlay.scrollWidth; checkMashCompression(c); return c; }
  function removeChip(chip){ if(!chip) return; const prev=chip.previousSibling, next=chip.nextSibling; if(prev && prev.classList && prev.classList.contains('sep')) prev.remove(); else if(next && next.classList && next.classList.contains('sep')) next.remove(); chip.remove(); if(currentSelectedChip===chip) currentSelectedChip=null; closePopover(); }
  $('#clearBtn').addEventListener('click',()=>{ overlay.innerHTML=''; currentSelectedChip=null; closePopover(); pressLog.length=0; });

  /* ===== Selection & Popover ===== */
  function selectChip(chip){ if(currentSelectedChip===chip) return; if(currentSelectedChip) currentSelectedChip.classList.remove('selected'); currentSelectedChip=chip; chip.classList.add('selected'); chip.focus(); }
  document.addEventListener('click', (e)=>{ if(popover.style.display==='block'){ if(!popover.contains(e.target) && (!currentSelectedChip || !currentSelectedChip.contains(e.target))){ closePopover(true); } } });
  function openPopover(chip, startFocused=false){ const rect=chip.getBoundingClientRect(); popover.style.display='block'; popover.style.left=Math.max(8,Math.min(window.innerWidth-300, rect.left))+'px'; popover.style.top=(rect.bottom+6+window.scrollY)+'px'; const labelText=(chip.innerText||'').trim(); popover.innerHTML=`
      <h5>Chip actions</h5>
      <div class="row"><input id="renameInput" type="text" value="${escapeHtml(labelText)}"><button id="applyBtn" class="btn">Apply</button></div>
      <div class="row"><button id="editFromController" class="btn">Replace with controller</button><button id="delBtn" class="btn danger">Delete</button></div>
      <div class="row"><small>Enter = apply · Esc/Click outside = cancel · Up/Space = prepend <b>j.</b></small></div>`; const inp=$('#renameInput'); const applyBtn=$('#applyBtn'); const delBtn=$('#delBtn'); const ctlBtn=$('#editFromController');
    if(startFocused) inp.focus();
    applyBtn.onclick=()=>{ applyRename(inp.value); };
    delBtn.onclick=()=>{ removeChip(currentSelectedChip); };
    ctlBtn.onclick=()=>{ startControllerEdit(); };
  }
  function closePopover(cancel=false){ popover.style.display='none'; editCaptureMode=false; if(cancel && currentSelectedChip) currentSelectedChip.classList.remove('selected'); }
  function applyRename(newTxt){ if(currentSelectedChip){ currentSelectedChip.innerText=newTxt; } closePopover(); }

  // Delete key & Enter/Esc in rename
  window.addEventListener('keydown',(e)=>{
    if((e.key==='Delete'||e.key==='Backspace') && currentSelectedChip && popover.style.display==='block'){ e.preventDefault(); removeChip(currentSelectedChip); }
    if(e.key==='Enter' && popover.style.display==='block'){ const inp=$('#renameInput'); if(inp){ e.preventDefault(); applyRename(inp.value); } }
    if(e.key==='Escape' && popover.style.display==='block'){ e.preventDefault(); closePopover(true); }
    // Single‑click helpers: Up arrow or Space → j.
    if((e.key==='ArrowUp' || e.key===' ') && currentSelectedChip){ e.preventDefault(); prependJumpDot(currentSelectedChip); }
  });
  function prependJumpDot(chip){ const t=chip.innerText||''; if(!t.startsWith('j.')) chip.innerText='j.'+t; }

  /* ===== Mash compression (with direction context) ===== */
  const pressLog=[]; // {label, dir, t}
  function latestDirToken(){ return lastDirTok || 'n'; }
  function checkMashCompression(newChip){ const label=(newChip.innerText||'').trim(); const dir=newChip.dataset.dir || 'n'; const now=performance.now(); pressLog.push({label,dir,t:now}); // keep 1.2s
    while(pressLog.length && now-pressLog[0].t>1200) pressLog.shift();
    // Count consecutive chips at end with same label & dir
    const chips=[...overlay.querySelectorAll('.chip')]; let count=0; for(let i=chips.length-1;i>=0;i--){ const ch=chips[i]; if(ch===newChip || count>0){ if((ch.innerText||'').trim()===label && (ch.dataset.dir||'n')===dir){ count++; } else { break; } } }
    if(count>=3){ // compress: keep first of the run
      let run=0; for(let i=chips.length-1;i>=0;i--){ const ch=chips[i]; if((ch.innerText||'').trim()===label && (ch.dataset.dir||'n')===dir){ run++; if(run===count){ ch.innerText=label+" Mash"; break; } else { // remove newer duplicates
          removeChip(ch);
        } } }
    }
  }

  /* ===== Copy text (numpad) ===== */
  const dirMap={ul:'7',u:'8',ur:'9',l:'4',n:'5',r:'6',dl:'1',d:'2',dr:'3'};
  function toNumpadText(s){ let t=s; for(const [k,v] of Object.entries(dirMap)){ t=t.replace(new RegExp('(?<![a-z])'+k+'(?![a-z])','gi'), v); } return t; }
  $('#copyTxt').addEventListener('click',()=>{ const chips=[...overlay.querySelectorAll('.chip')]; const text=chips.map(c=>toNumpadText(c.innerText)).join(knobs.separator.value?(' '+knobs.separator.value+' '):' > '); navigator.clipboard.writeText(text); });

  /* ===== Export / Copy PNG (inline images to avoid taint) ===== */
  async function inlineImages(node){ const imgs=node.querySelectorAll('img'); for(const img of imgs){ if(img.src.startsWith('data:')) continue; try{ const res=await fetch(img.src,{mode:'cors'}); const blob=await res.blob(); const fr=new FileReader(); await new Promise(r=>{ fr.onload=()=>{ img.setAttribute('data-orig',img.src); img.src=fr.result; r(); }; fr.readAsDataURL(blob); }); }catch(e){ /* ignore */ } } }
  function restoreImages(node){ node.querySelectorAll('img[data-orig]').forEach(img=>{ img.src=img.getAttribute('data-orig'); img.removeAttribute('data-orig'); }); }
  async function exportOverlay(){ await inlineImages(overlay); const canvas=await html2canvas(overlay,{backgroundColor:null}); restoreImages(overlay); const a=document.createElement('a'); a.download='notation.png'; a.href=canvas.toDataURL('image/png'); a.click(); }
  async function copyOverlay(){ await inlineImages(overlay); const canvas=await html2canvas(overlay,{backgroundColor:null}); restoreImages(overlay); canvas.toBlob(b=>{ if(b) navigator.clipboard.write([new ClipboardItem({'image/png':b})]); }); }
  $('#exportImg').addEventListener('click',exportOverlay); $('#copyImg').addEventListener('click',copyOverlay);

  /* ===== Gamepad: edit & j. ===== */
  // Simple mapping for demo; change to your labels as needed
  const BUTTON_LABELS=['L','M','H','S','LB','RB','LT','RT','Sel','Start','L3','R3'];
  const resetSel=$('#resetAction'); resetSel.innerHTML=['none',...Array.from({length:16},(_,i)=>`button:${i}`)].map(v=>`<option value="${v}">${v}</option>`).join('');
  function labelForButton(i){ return BUTTON_LABELS[i]||('#'+i); }

  let gpIndex=null, prevButtons=[], lastDirTok='n', lastButtonTime=new Map();
  function now(){ return performance.now(); }
  function tokFromAxes(ax,ay,dz=0.5){ let h=null,v=null; if(Math.abs(ax)>=dz) h=ax<0?'l':'r'; if(Math.abs(ay)>=dz) v=ay<0?'u':'d'; if(h&&v) return v+h; return h||v||'n'; }
  function trackDir(gp){ const dU=gp.buttons[12]?.pressed, dD=gp.buttons[13]?.pressed, dL=gp.buttons[14]?.pressed, dR=gp.buttons[15]?.pressed; let tok='n'; if(dL) tok='l'; else if(dR) tok='r'; if(dU) tok=(tok==='r')?'ur':(tok==='l')?'ul':'u'; else if(dD) tok=(tok==='r')?'dr':(tok==='l')?'dl':'d'; if(tok==='n') tok=tokFromAxes(gp.axes[0]||0,gp.axes[1]||0,0.5); lastDirTok=tok; }

  window.addEventListener('gamepadconnected',e=>{gpIndex=e.gamepad.index; prevButtons=e.gamepad.buttons.map(b=>b.pressed); statusEl.textContent=`Connected: ${e.gamepad.id}`;});
  window.addEventListener('gamepaddisconnected',()=>{gpIndex=null; statusEl.textContent='Gamepad disconnected';});
  function poll(){ const pads=navigator.getGamepads?.(); let gp=(gpIndex!=null)?pads[gpIndex]:null; if(!gp){ for(const g of pads){ if(g){ gp=g; gpIndex=g.index; prevButtons=g.buttons.map(b=>b.pressed); break; } } }
    if(gp){ trackDir(gp); handleButtons(gp); } requestAnimationFrame(poll); } requestAnimationFrame(poll);

  function handleButtons(gp){ const t=now(); const justPressed=[]; for(let i=0;i<gp.buttons.length;i++){ const pressed=!!gp.buttons[i].pressed, was=!!prevButtons[i]; if(pressed && !was){ const last=lastButtonTime.get(i)||0; if(t-last>=110){ justPressed.push(i); lastButtonTime.set(i,t);} } prevButtons[i]=pressed; }
    if(!justPressed.length) return;
    // Reset button action
    if(resetSel.value && resetSel.value!=='none'){ const btn=parseInt(resetSel.value.split(':')[1]); if(justPressed.includes(btn)){ overlay.innerHTML=''; pressLog.length=0; currentSelectedChip=null; closePopover(); return; } }

    // If editing a chip from controller → replace instead of adding a new one
    if(editCaptureMode && currentSelectedChip){ const attackIdx=justPressed.find(i=>i<12); if(attackIdx!=null){ currentSelectedChip.innerText = (lastDirTok!=='n' ? dirAbbrev(lastDirTok)+' ' : '') + labelForButton(attackIdx); currentSelectedChip.dataset.dir=lastDirTok; closePopover(); return; } }

    // Not editing → normal add; also allow j. via up direction
    const attackIdx=justPressed.find(i=>i<12);
    if(attackIdx!=null){ const txt = (lastDirTok!=='n' ? dirAbbrev(lastDirTok)+' ' : '') + labelForButton(attackIdx); const chip=addChip(escapeHtml(txt), lastDirTok); // j. helper if Up is held
      if(lastDirTok.includes('u')) prependJumpDot(chip);
    } else {
      // If only D-Pad Up pressed while a chip selected → j.
      if(currentSelectedChip && (justPressed.includes(12))){ prependJumpDot(currentSelectedChip); }
    }
  }

  function startControllerEdit(){ editCaptureMode=true; const inp=$('#renameInput'); if(inp) inp.blur(); statusEl.textContent='Controller edit: press a button (optionally hold a direction) to replace the selected chip'; }

  function dirAbbrev(tok){ const map={u:'8',d:'2',l:'4',r:'6',ul:'7',ur:'9',dl:'1',dr:'3'}; // for display in text we keep classic tokens; numpad used only in copy
    // show classic short tokens in the chip (u, d, l, r, etc.)
    return tok; }

  /* ===== Utilities ===== */
  function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  /* ===== Demo ===== */
  $('#addDemo').addEventListener('click',()=>{ addChip('L'); addChip('L'); addChip('L'); addChip('2 M','d'); });

  // OBS helper: hide panel if ?obs=1 and toggle with E
  const qp=new URLSearchParams(location.search); if(qp.get('obs')==='1' || window.obsstudio){ document.querySelector('.panel').style.display='none'; }
  window.addEventListener('keydown',(e)=>{ if(e.key.toLowerCase()==='e'){ const p=document.querySelector('.panel'); p.style.display=(p.style.display==='none')?'grid':'none'; }});
  </script>
</body>
</html>